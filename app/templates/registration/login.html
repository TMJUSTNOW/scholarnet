{% load staticfiles %}
<!DOCTYPE html>
<html lang="en">
    <head>
        {% include "meta.html" %}
        <title>ScholarNet - Home</title>

        <link rel="icon" href="{% static 'images/favicon.jpg' %}">
        <link rel="stylesheet" href="{% static 'materialize/css/materialize.min.css' %}">
        <link rel="stylesheet" href="{% static 'materialize/css/animate.css' %}">
        <link rel="stylesheet" href="{% static 'materialize/css/main.css' %}">
        <link rel="stylesheet" href="{% static 'materialize/css/material-design-iconic-font.min.css' %}">

        <style>

            /*********************************
            END FLEX ALIGNMENT STUFF
        *********************************/

            .layout-flex{
                display: -webkit-flex;
                display: flex;
            }
            .layout-flex.center-center{
                justify-content: center;
                align-items: center;
            }

            .layout-flex.as-row{
                flex-direction: row;
            }

            .layout-flex.as-column{
                flex-direction: column;
            }

            /*HORIZONTAL ALIGNMENT*/
            .layout-flex.h-start{
                justify-content:flex-start;
            }
            .layout-flex.h-end{
                justify-content:flex-end;
            }
            .layout-flex.h-space-between{
                justify-content:space-between;
            }
            .layout-flex.h-space-around{
                justify-content:space-around;
            }


            /*VERTICAL ALIGNMENT*/
            .layout-flex.v-center{
                align-items: center;
            }
            .layout-flex.v-start{
                align-items: flex-start;
            }
            .layout-flex.v-end{
                align-items: flex-end;
            }

            /*CHILD ALIGNMENT OVERRIDES*/

            /*VERTICAL ALIGNMENT*/
            .self-v-center{
                align-self: center;
            }
            .self-v-start{
                align-self: flex-start;
            }
            .self-v-end{
                align-self: flex-end;
            }

            /*HORIZONTAL ALIGNMENT*/
            .self-h-center{
                justify-self: center;
            }
            .self-h-start{
                justify-self: flex-start;
            }
            .self-h-end{
                justify-self: flex-end;
            }

            /*********************************
                END FLEX ALIGNMENT STUFF
            *********************************/
        </style>
    </head>
    <body style="background: #f9f9f9">
        <div class="layout-flex center-center hide-on-med-and-up" style="position: absolute;top:0;left:0;height: 100%;width: 100%;">
            <p class="flow-text">
                Please go download the app.
            </p>
        </div>

        <div class="container hide-on-small-only">
            <div class="card" style="background:url({% static 'images/beautifulsea.jpg' %}); background-repeat: no-repeat; background-size: cover; margin: 60px auto;">
                <div class="card-content" style="padding: 0;margin:0;">
                    <div class="row" style="padding: 0;margin:0;background: rgba(0,0,0, 0.2);">
                        <div class="col m6 re" style="padding-top:3px;">
                            <div class="valign-wrapper" style="height: 500px">
                                <div class="valign grey-text text-lighten-3" style="padding: 20px; margin: auto">
                                    <img style="display: block; margin:auto" src="{% static 'images/snet.png' %}" alt="">
                                    <h3 class="center-align">
                                        Scholarnet
                                    </h3>
                                    <hr>
                                    <br><br>
                                    <p class="flow-text center">
                                        <em><q>Share your knowledge. It is a way to achieve Immortality.</q></em><br>
                                        <strong class="right">- Dalai Lama</strong>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <style>
                            .a-form{
                                box-shadow: 0 0 1px rgba(0, 0, 0, 0.3);
                                position: absolute;top:0; left: 0;
                                margin: 15px;padding: 20px;
                                background: #fefefe;
                                /*display: none;*/
                            }
                        </style>
                        <div class="col m6 s12 whit" style="padding:30px; position: relative;height: 503px;">
                            <div hidde class="a-form" style="padding-top:55px;padding-bottom:55px;margin: 30px 30px;z-index: 99">
                                <form method="post" role="form" action="/login/" id="login" class="center-align js-login-form">
                                    <span class="card-title" style="color:#444; padding-left: 10px;">
                                        LOGIN
                                    </span>
                                    {% csrf_token %}
                                    <div class="col m12 input-field">
                                        <input type="text" name="username" id="username" autocomplete="off" required />
                                        <label for="username">Phone-Number</label>
                                    </div>
                                    <div class="col m12 input-field">
                                        <input type="password" class="form-control" name="password" id="passwd" autocomplete="off" required />
                                        <label for="passwd">Password</label>
                                    </div>
                                    <div class="col m12" style="margin: 15px 0; text-align: left;">
                                        <a href="/user/password/reset/">Forgot password?</a>
                                    </div>
                                    <div class="col m12">
                                        <button type="submit" class="btn blue waves-effect waves-light right">
                                            Log In
                                        </button>
                                    </div>
                                    <div class="col m12">
                                        <div class="input-field left-align">
                                            No account yet? <a onclick="switchForm('register')" href="javascript:void(0);" class="btn-flat blue-text waves-effect waves-blue" style="padding: 0 5px">Register.</a>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="a-form" style="display: none;">
                                <form method="post" role="form" action="/app/register/"  class="center-align js-registration-form">
                                    {% csrf_token %}
                                    {% load widget_tweaks %}
                                    <span class="card-title" style="color:#444">
                                        REGISTER
                                    </span>
                                    <div class="col m12 input-field">
                                        <input id="phoneNum" type="text" name="username" required />
                                        <label>Phone Number</label>
                                    </div>
                                    <div class="col m12 input-field">
                                        <input id="password" type="password" name="password" required />
                                        <label>Password</label>
                                    </div>
                                    <div class="col m12 input-field">
                                        <input id="password1" type="password" name="password1" class="form-control" required />
                                        <label>Confirm Password</label>
                                    </div>
                                    <div class="col m12 input-field" style="height: 65px">
                                        <span class="left-align" style="position: relative;left:-45px;top:10px;line-height: 25px; text-align: left;">Register as: </span>
                                        <span>
                                          <input class="with-gap" name="role" value="Student" type="radio" id="student" />
                                          <label for="student">Student</label>
                                          &emsp;&emsp;
                                          <input class="with-gap" name="role" value="Teacher" type="radio" id="lecturer" />
                                          <label for="lecturer">Lecturer</label>
                                        </span>
                                    </div>
                                    <div class="form-group">
                                        <center>
                                            <div class="g-recaptcha" data-sitekey="6LdNwRwTAAAAABHKqJPjv1jDQbw8psVaBCvciiN1"></div>
                                        </center>
                                    </div>
                                    <div class="col m12" style="margin-bottom: 22px;text-align: left;">
                                        <input id="termsAndConditions" type="checkbox" required>
                                        <label for="termsAndConditions">Terms and Conditions</label>
                                    </div>
                                    <div class="col m12">
                                        <a onclick="switchForm('login')" href="javascript:void(0);" class="btn-flat blue-text left">Back to Login</a>
                                        <button type="submit" class="btn blue right">Register</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <center class="blue-text hide-on-small-only" style="margin-top:-30px; font-size: 20px;">
            Copyright &copy; 2016 Scholarnet
        </center>

        <script src="{% static 'assets/js/jquery-1.11.1.min.js' %}"></script>
        <script src="{% static 'materialize/js/materialize.min.js' %}" type="text/javascript"></script>
        <script src="{% static 'assets/js/TweenMax.min.js' %}"></script>
        <script src="{% static 'materialize/js/utils.js' %}" type="text/javascript"></script>
        <script>
            function switchForm(to){
                $('.a-form').fadeToggle(400);
            }

            $(document).ready(function(){
                $(".js-registration-form").on('submit', function(e){
                    e.preventDefault();
                    var data = $(this).serialize();

//                  [{"phone": "+255715497059", "message": "Successfully Registered", "status": true}]
                   if(validateRegisterForm()){
                       var registeringToastId = createToast("Registering...", false);

                       $.ajax({
                           url: '/app/register/',
                           type: 'POST',
                           data: data
                       })
                       .done(function(data) {
                           var registerResponse = JSON.parse(data)[0];
                           console.log("success. with data", registerResponse);
                           //[{"phone": "+255715497059", "message": "Successfully Registered", "status": true}]
                           setTimeout(function(){
                               if(registerResponse.status){
                                   createToast("Registered, login.");
                                   $('.js-login-form input[name="username"]').val(registerResponse.phone);
                                   $('.js-login-form input[name="password"]').val("");
                                   switchForm('login');
                               }else{
                                   createToast(registerResponse.message);
                               }
                           },300);
                       })
                       .fail(function(error) {
                           console.log("error returned is", error);
                           setTimeout(function(){
                               createToast("Error occured");
                           },300);
                       })
                       .always(function() {
                           hideToast(registeringToastId, 300, true);
                           console.log("Action complete!");
                       });
                   }
                });

                $(".js-login-form").on('submit', function(e){
                    e.preventDefault();
                    var data = $(this).serialize();

                    if(validateLoginForm()){
                        var loginToastId = createToast("Signing in...", false);
                        $.ajax({
                            url: '/login/',
                            type: 'POST',
                            data: data
                        })
                        .done(function(data) {
                            var loginResponse = JSON.parse(data)[0];
                            if(loginResponse.status){
                                console.log("success. with data", loginResponse);
                                window.location = "/app/home/";
                            }
                            else{
                                console.log("Account not found.");
                                createToast("Account not found.");
                            }
                        })
                        .fail(function(error) {
                            console.log("error returned is", error);
                            setTimeout(function(){
                                createToast("Error occured");
                            },300);
                        })
                        .always(function() {
                            hideToast(loginToastId, 300, true);
                            console.log("Action complete!");
                        });
                    }
                });
            });

            function validateLoginForm(){
                var phoneNum = $('.js-login-form input[name="username"]').val();
                var password = $('.js-login-form input[name="password"]').val();

                if(validatePhoneNumber(phoneNum)){
                    console.log("Phone pass, now testing passwords!");
                    var passWordCheck = validatePassword(password);

                    if(passWordCheck){
                        return true;
                    }else{
                        $('.js-login-form input[name="password"]').focus();
                        createToast("Password too short.");
                    }
                }else{
                    console.log("Phone test failed.");

                    $('.js-login-form input[name="username"]').focus();
                    createToast("Invalid phone number");
                }
            }

            function validateRegisterForm(){
                var phoneNum = $('.js-registration-form input[name="username"]').val();
                var password = $('.js-registration-form input[name="password"]').val();
                var password1 = $('.js-registration-form input[name="password1"]').val();

                console.log("Testing phone!");

                if(validatePhoneNumber(phoneNum)){
                    console.log("Phone pass, now testing passwords!");
                    var passWordCheck = validatePasswords(password, password1);

                    if(passWordCheck.pass){
                        return true;
                    }else{
                        createToast(passWordCheck.message);
                    }
                }else{
                    console.log("Phone test failed.");

                    $('input[name="username"]').focus();
                    createToast("Invalid phone number");
                }
            }

            function validatePhoneNumber(phone){
                var hasPlusPhone = phone[0] == '+';

                if(hasPlusPhone)
                    var toValidatePhone = phone.substring(1, phone.length);
                else
                    var toValidatePhone = phone;

                return toValidatePhone.length >= 10 && !isNaN(toValidatePhone);
            }

            function validatePasswords(password, password1){
                if(password == password1){
                    var passVal = validatePassword(password);
                    console.log(passVal.message);
                    if(passVal.pass)
                        return { pass : true };
                    else
                        return passVal;
                }else{
                    return { pass : false, message : "Passwords don't match"};
                }
            }

            function validatePassword(password){
                if(password.length >= 6)
                    return hasNumber(password);
                else
                    return { pass : false, message : "Password too short"};
            }

            function hasNumber(text){
                for(var i = 0; i < text.length; i++){
                    if(!isNaN(text[i]))
                        return { pass : true};
                }

                return { pass : false, message : "Password should have a number"};
            }
        </script>
    </body>
</html>